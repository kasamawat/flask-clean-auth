name: CD - Deploy Flask Backend to GCP VM

on:
  workflow_run:
    workflows: ["CI - Flask Backend"]
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to GCP VM via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          script: |
            set -e
            cd ~/flask-clean-auth
            git pull origin main
            echo "${{ github.sha }}" > .deploy_sha
            source .venv/bin/activate
            flask db upgrade
            sudo systemctl restart flask-auth
            sudo systemctl reload nginx
